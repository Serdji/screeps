/*
 * Module code goes here. Use 'module.exports' to export things:
 * module.exports.thing = 'a thing';
 *
 * You can import it from another modules like this:
 * var mod = require('CreepRoleWorkingAbroad');
 * mod.thing == 'a thing'; // true
 */
import { CreepWorking } from "./CreepWorking";

export class CreepRoleWorkingAbroadBuilder extends CreepWorking {
  private roomName: string;
  private roomToHome: string;
  public constructor(roomName: string, nameSpawn: string, properties: IProperties, roomToHome = "") {
    super(nameSpawn, properties);
    this.roomName = roomName; // –ò–º—è –∫–æ–º–Ω–∞—Ç—ã, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∏–ø—Å–∞
    this.roomToHome = roomToHome;
    this.spawn();
  }

  public run(creep: Creep): void {
    this.roomName = _.isEmpty(this.roomToHome) ? creep.room.name : this.roomToHome; // –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞—Ç—å –¥–æ–º–∞—à–Ω—é—é –∫–æ–º–Ω–∞—Ç—É —Ä—É–∫–∞–º–∏, –±–µ—Ä–µ–º –∫–æ–º–Ω–∞—Ç—É –∏–∑ –ø–∞–º—è—Ç–∏ –∫—Ä–∏–ø—Å–∞
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –∏–º—è –∫–æ–º–Ω–∞—Ç—ã –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –∫—Ä–∏–ø—Å —Å –∏–º–µ–Ω–µ–º –∫—É–¥–∞ –µ—Ö–µ—Ç—å
    // –µ–ª—Å–∏ –Ω–µ—Ç, –µ–¥–µ–º –≤ —Ç—É –∫–æ–º–Ω–∞—Ç—É
    if (this.roomName !== this.roomName && !creep.memory.building) {
      this.toRoom(creep, this.roomName);
      // –ö–∞–∫ –ø—Ä–∏–µ—Ö–∞–ª–∏ –≤ –Ω—É–∂–Ω—É—é –∫–æ–º–Ω–∞—Ç—É, –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å
    } else {
      if (creep.memory.building && creep.store[RESOURCE_ENERGY] === 0) {
        creep.memory.building = false;
        creep.say("üîÑ –ö–æ–ø–∞—Ç—å");
      }
      if (!creep.memory.building && creep.store.getFreeCapacity() === 0) {
        creep.memory.building = true;
        creep.say("üèó –°—Ç—Ä–æ–∏—Ç—å");
      }

      if (creep.memory.building) {
        const constructions = creep.room.find(FIND_CONSTRUCTION_SITES);

        // –ï—Å—Ç–∏ –µ—Å—Ç—å —á—Ç–æ –ø–æ—Å—Ç–æ—Ä–æ–∏—Ç—å, —Å—Ç—Ä–æ–∏–º
        if (constructions.length) {
          const construction = Game.getObjectById(constructions[0].id) as ConstructionSite;
          if (creep.build(construction) === ERR_NOT_IN_RANGE) {
            creep.moveTo(construction, { visualizePathStyle: { stroke: "#ffffff" } });
          }
          // –ï—Å–ª–∏ –Ω–µ—á–µ–≥–æ —Å—Ç–æ–∏—Ç—å –∏ –ø–æ–ª—å–Ω–æ—Å—Ç—å—é –∑–∞–±–∏—Ç –∫–ª–∞–¥, –µ–¥–µ–º –¥–æ–º–æ–π
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –∏–º—è –¥–æ–º–∞—à–Ω–µ–π –∫–æ–º–Ω–∞—Ç—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–º–Ω–æ—Ç–æ–π –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏—Å—è –∫—Ä–∏–ø—Å, –µ–¥–µ–º –≤ —Ç—É –∫–æ–º–Ω–∞—Ç—É
          if (creep.memory.roomName !== this.roomName && creep.memory.building) {
            const exitDir = Game.map.findExit(creep.room, creep.memory.roomName) as ExitConstant;
            const exit = creep.pos.findClosestByRange(exitDir) as RoomPosition;
            creep.moveTo(exit);
            // –ï—Å–ª–∏ –∏–º–µ–Ω–∞ —Å–æ–≤–ø–∞–ª–∏, –µ–¥–µ–º —É–±–≥—Ä–µ–π–∂–∏–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä
          } else {
            if (creep.upgradeController(creep.room.controller as StructureController) === ERR_NOT_IN_RANGE) {
              creep.moveTo(creep.room.controller as StructureController, { visualizePathStyle: { stroke: "#ffffff" } });
            }
          }
        }
      } else {
        this.mining(creep);
      }
    }
  }

  public mining(creep: Creep) {
    super.mining(creep);
  }

  public toRoom(creep: Creep, roomName: string): boolean {
    return super.toRoom(creep, roomName);
  }

  public toHome(creep: Creep, roomToHome: string): boolean {
    return super.toHome(creep, roomToHome);
  }

  public spawn(): void {
    const { ROLE_WORKING_ABROAD_BUILDER, LIMIT_WORKING_ABROAD_BUILDER } = this.properties;
    super.spawn(ROLE_WORKING_ABROAD_BUILDER + this.roomName, LIMIT_WORKING_ABROAD_BUILDER as ILimitCreep);
  }
}
